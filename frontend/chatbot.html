<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FarmWise Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script>
        // Apply theme early to prevent flash
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark-mode');
        } else {
            document.documentElement.classList.remove('dark-mode');
        }
    </script>
    <style>
        :root {
            --header-footer-bg: #FFFFFF; --main-bg: #EAF4EE; --text-primary: #202123;
            --text-secondary: #5F6368; --input-bg: #F1F3F4; --border-color: #DEE2E6;
            --send-btn-bg: #2ECC71; --bot-bubble-bg: #FFFFFF; --user-bubble-bg: #DCF8C6;
            --shadow-color: rgba(0,0,0,0.07); --sidebar-bg: #F8F9FA; --sidebar-hover-bg: #E9ECEF;
            --danger-red: #e74c3c; --accent-green: #2ECC71; --accent-green-hover: #27ae60;
        }
        html.dark-mode { /* Changed from body.dark-mode to html.dark-mode */
            --header-footer-bg: #161b22; --main-bg: #0D1117; --text-primary: #c9d1d9;
            --text-secondary: #8b949e; --input-bg: #3C4043; --border-color: #30363d;
            --bot-bubble-bg: #3C4043; --user-bubble-bg: #004D40; --shadow-color: rgba(0,0,0,0.2);
            --sidebar-bg: #2D2E30; --sidebar-hover-bg: #3C4043; --accent-green-hover: #58d68d;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; display: flex; height: 100dvh; background-color: var(--main-bg); color: var(--text-primary); overflow: hidden; transition: background-color 0.3s, color 0.3s; }
         html.dark-mode body { /* Apply body styles in dark mode too */
             background-color: var(--main-bg);
             color: var(--text-primary);
         }
        a { text-decoration: none; color: inherit; }
        /* Sidebar Styles */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; transition: margin-left 0.3s ease; position: fixed; /* Keep fixed */ top: 0; left: 0; height: 100%; z-index: 200; margin-left: -260px; /* Initially hidden */ }
        body.sidebar-open .sidebar { margin-left: 0; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .new-chat-btn { width: 100%; padding: 10px 15px; border-radius: 8px; background: var(--header-footer-bg); color: var(--text-primary); display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.95rem; border: 1px solid var(--border-color); transition: background-color 0.2s; }
        .new-chat-btn:hover { background-color: var(--sidebar-hover-bg); }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .recent-title { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 10px; padding-left: 5px; }
        #recent-chats-list { list-style: none; }
        #recent-chats-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; transition: background-color 0.2s; }
        #recent-chats-list li:hover { background-color: var(--sidebar-hover-bg); }
        #recent-chats-list li.active { background-color: var(--accent-green); color: white; }
         #recent-chats-list li.active:hover { background-color: var(--accent-green-hover); }
        .chat-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; pointer-events: none; /* Prevent clicks on text from interfering */ margin-right: 5px; }
        .delete-chat-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; opacity: 0; transition: opacity 0.2s, color 0.2s; padding: 5px; border-radius: 5px; flex-shrink: 0; }
        #recent-chats-list li:hover .delete-chat-btn { opacity: 1; }
        #recent-chats-list li.active .delete-chat-btn { color: white; opacity: 0.7;}
        #recent-chats-list li.active:hover .delete-chat-btn { opacity: 1; }
        .delete-chat-btn:hover { color: var(--danger-red); }
         #recent-chats-list li.active .delete-chat-btn:hover { color: #ffdddd; }

        .sidebar-footer { padding: 10px 15px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .sidebar-nav-link { display: flex; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 8px; color: var(--text-primary); font-weight: 500; transition: background-color 0.2s; }
        .sidebar-nav-link:hover { background-color: var(--sidebar-hover-bg); }
        .sidebar-nav-link i { width: 20px; text-align: center; color: var(--text-secondary); }

        /* Chat Container Styles */
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; height: 100dvh; margin-left: 0; /* Adjusted for sidebar logic */ transition: margin-left 0.3s ease; }
        /* Shift chat container only on larger screens when sidebar opens */
         @media (min-width: 769px) {
            .chat-container { margin-left: 260px; }
            body.sidebar-closed .chat-container { margin-left: 0; }
         }

        /* Chat Header */
        .chat-header { background-color: var(--header-footer-bg); padding: 15px 30px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 20px; flex-shrink: 0; }
        .chat-header h2 { font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 600; flex-grow: 1; /* Allow title to take space */ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .icon-btn { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items:center; justify-content:center; }
         .icon-btn:hover { background-color: var(--sidebar-hover-bg); }
        .theme-button i { transition: transform 0.3s ease; } /* Add rotation effect */
         html.dark-mode .theme-button i.fa-sun { transform: rotate(90deg); }
         html:not(.dark-mode) .theme-button i.fa-moon { transform: rotate(90deg); }


        /* Chat Main Area */
        .chat-main { flex-grow: 1; overflow-y: auto; padding: 30px 40px; }
        .chat-message-container { max-width: 1100px; width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        /* Message Styles */
        .message { display: flex; align-items: flex-start; gap: 15px; max-width: 85%; animation: fadeIn 0.3s ease-out; }
         @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--sidebar-hover-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-secondary); flex-shrink: 0; }
        .message-bubble { padding: 12px 18px; border-radius: 18px; box-shadow: 0 2px 4px var(--shadow-color); word-wrap: break-word; overflow-wrap: break-word; position: relative; } /* Added relative */
        .bot-message { align-self: flex-start; }
        .bot-message .message-bubble { background-color: var(--bot-bubble-bg); border: 1px solid var(--border-color); border-top-left-radius: 4px; }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .message-bubble { background-color: var(--user-bubble-bg); border-bottom-right-radius: 4px; }
         html.dark-mode .user-message .message-bubble { color: #e0e0e0; }
        .message-content p { color: var(--text-primary); line-height: 1.6; white-space: pre-wrap; margin: 0; }
        .message-content img { display: block; max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px; cursor: pointer; object-fit: contain; }
         /* Speaker Button */
         .speaker-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.3s, color 0.3s; padding: 5px; position: absolute; right: 8px; bottom: 8px; }
         .bot-message .message-bubble:hover .speaker-btn { opacity: 0.7; }
         .speaker-btn:hover { color: var(--accent-green); opacity: 1; }

        /* Footer Input Area */
        .footer { background-color: var(--header-footer-bg); padding: 15px 30px; box-shadow: 0 -2px 4px var(--shadow-color); border-top: 1px solid var(--border-color); z-index: 10; flex-shrink: 0; }
        .chat-input-container { max-width: 1100px; margin: 0 auto; }
        #image-preview-container { margin-bottom: 10px; position: relative; display: none; width: fit-content; }
        #image-preview { display: block; max-height: 100px; border-radius: 8px; border: 1px solid var(--border-color); }
        #remove-image-btn { position: absolute; top: -10px; right: -10px; background: var(--header-footer-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px var(--shadow-color); }
         #remove-image-btn:hover { color: var(--danger-red); background-color: var(--sidebar-hover-bg); }
        .chat-input-form { display: flex; align-items: center; gap: 10px; }
        .input-wrapper { flex-grow: 1; display: flex; align-items: center; background-color: var(--input-bg); border-radius: 28px; padding: 0 20px; transition: box-shadow 0.2s; }
         .input-wrapper:focus-within { box-shadow: 0 0 0 2px var(--accent-green); }
        .input-wrapper input { width: 100%; border: none; outline: none; font-size: 1rem; color: var(--text-primary); background: none; padding: 14px 0; height: 50px; } /* Ensure height matches buttons */
         .input-wrapper input::placeholder { color: var(--text-secondary); opacity: 0.8; }
        .send-btn { background-color: var(--send-btn-bg); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: background-color 0.2s, transform 0.1s; }
        .send-btn:hover { background-color: var(--accent-green-hover); }
         .send-btn:active { transform: scale(0.9); }
        .send-btn:disabled { background-color: #9E9E9E; cursor: not-allowed; }
        .send-btn svg { width: 20px; height: 20px; }
         /* Input area icon buttons */
         .chat-input-form .icon-btn { width: 50px; height: 50px; flex-shrink: 0; font-size: 18px; }

         /* Mobile Sidebar Overlay */
         .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 199; }
         body.sidebar-open .sidebar-overlay { display: block; }
         @media (min-width: 769px) { .sidebar-overlay { display: none !important; } }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .sidebar { margin-left: -260px; /* Fully hidden */ width: 260px; /* Ensure width is fixed */ }
            .chat-container { margin-left: 0; } /* Chat always takes full width */
            body.sidebar-open .sidebar { margin-left: 0; } /* Sidebar slides in */
             /* Remove chat container margin shift on mobile */
             body.sidebar-open .chat-container { margin-left: 0; }

            .chat-header { padding: 10px 15px; gap: 10px; }
            .chat-main { padding: 15px; }
            .message { max-width: 95%; }
            .footer { padding: 10px 15px; }
             .chat-input-form { gap: 5px; }
             .input-wrapper { padding: 0 15px; }
             .input-wrapper input { height: 44px; font-size: 0.95rem; }
             .chat-input-form .icon-btn, .send-btn { width: 44px; height: 44px; }
             .send-btn svg { width: 18px; height: 18px; }

        }
    </style>
</head>
<body class="sidebar-closed"> <script>
        // AUTH GUARD: Redirect to login if token is not found.
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }
    </script>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" id="new-chat-btn"><i class="fa-solid fa-plus"></i> New Chat</button>
        </div>
        <div class="sidebar-content">
            <p class="recent-title">Recent Chats</p>
            <ul id="recent-chats-list">
                </ul>
        </div>
        <div class="sidebar-footer">
            <a href="index.html" class="sidebar-nav-link">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </a>
            <a href="#" id="logout-btn" class="sidebar-nav-link">
                 <i class="fa-solid fa-right-from-bracket"></i>
                 <span>Logout</span>
             </a>
        </div>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="chat-container">
        <header class="chat-header">
            <button class="icon-btn" id="menu-toggle-btn" title="Toggle Menu"><i class="fa-solid fa-bars"></i></button>
            <h2 id="chat-header-title">FarmWise Bot</h2>
            <button id="theme-toggle" class="icon-btn theme-button" title="Toggle Theme" style="margin-left: auto;">
                 <i class="fa-solid fa-sun"></i> </button>
        </header>

        <main class="chat-main" id="chat-main">
            <div class="chat-message-container" id="message-container">
                </div>
        </main>

        <footer class="footer">
            <div class="chat-input-container">
                <div id="image-preview-container">
                    <img id="image-preview" src="" alt="Image preview" />
                    <button id="remove-image-btn" title="Remove image">&times;</button>
                </div>
                <form class="chat-input-form" id="chat-form">
                    <button type="button" class="icon-btn" id="image-btn" title="Upload Image"><i class="fa-solid fa-image"></i></button>
                    <input type="file" id="image-input" accept="image/*" style="display: none;" />
                    <div class="input-wrapper">
                        <input type="text" id="user-input" placeholder="Ask about crops, or upload an image..." autocomplete="off" />
                    </div>
                    <button type="submit" class="send-btn" id="send-btn" title="Send Message" disabled> <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                    </button>
                </form>
            </div>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & STATE ---
        const API_BASE_URL = 'https://main-back-g4pq.onrender.com'; // Your actual API URL
        let currentChatId = null;
        let selectedFile = null;

        // --- DOM ELEMENT SELECTORS ---
        const body = document.body;
        const messageContainer = document.getElementById('message-container');
        const chatMain = document.getElementById('chat-main');
        const newChatBtn = document.getElementById('new-chat-btn');
        const recentChatsList = document.getElementById('recent-chats-list');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const imageBtn = document.getElementById('image-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const chatHeaderTitle = document.getElementById('chat-header-title'); // Added
        const sidebarOverlay = document.getElementById('sidebar-overlay'); // Added
        const logoutBtn = document.getElementById('logout-btn'); // Added


        // --- API HELPERS ---
        const fetchWithAuth = async (url, options = {}) => {
            const token = localStorage.getItem('token');
            // Auth guard moved to top-level script for immediate redirect
            // if (!token) { /* ... */ }

            const headers = { ...(options.headers || {}), 'x-auth-token': token };

            if (options.body instanceof FormData) {
                delete headers['Content-Type']; // Browser sets this with boundary
            } else if (options.body && typeof options.body === 'object') {
                // Ensure body is stringified if it's a JSON object and not FormData
                options.body = JSON.stringify(options.body);
                headers['Content-Type'] = 'application/json';
            }

            try {
                const response = await fetch(url, { ...options, headers });

                if (response.status === 401) {
                    localStorage.clear(); // Use clear to remove token and potentially other user data
                    alert('Your session is invalid or expired. Please log in again.');
                    window.location.href = 'login.html';
                    throw new Error('Session expired'); // Stop further execution
                }

                 // Handle other non-OK responses generically
                 if (!response.ok) {
                    let errorMsg = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorMsg; // Use server message if available
                    } catch (e) { /* Ignore parsing error if body isn't JSON */ }
                    throw new Error(errorMsg);
                }

                return response; // Return the successful response
            } catch (error) {
                 console.error('Fetch Error:', error);
                 if (error.message !== 'Session expired') { // Avoid double alert
                    alert(`Network error or server unavailable: ${error.message}`);
                 }
                throw error; // Re-throw needed for caller's catch block
            }
        };

        // --- UI & CHAT FUNCTIONS ---

        // addMessage function (corrected version with safety checks)
         const addMessage = (sender, contentParts, isThinking = false) => {
             // **Safety Check 1: Ensure container exists**
             if (!messageContainer) {
                 console.error("Critical Error: messageContainer element not found.");
                 return null;
             }

             const messageDiv = document.createElement('div');
             messageDiv.classList.add('message', `${sender}-message`);

             const avatarIcon = sender === 'user' ? 'fa-user' : 'fa-robot';
             const messageContentDiv = document.createElement('div');
             messageContentDiv.className = 'message-content';

             let hasContent = false; // Track if anything was added

             if (contentParts && Array.isArray(contentParts) && contentParts.length > 0) {
                 contentParts.forEach(part => {
                     // Check part structure before accessing properties
                     if (part && part.type === 'text' && part.text != null && part.text.trim() !== '') {
                         const p = document.createElement('p');
                         p.textContent = part.text;
                         messageContentDiv.appendChild(p);
                         hasContent = true;
                     } else if (part && part.type === 'image_url' && part.image_url && part.image_url.url) {
                          const img = document.createElement('img');
                          img.src = part.image_url.url;
                          img.alt = "Chat image";
                          img.onerror = () => { img.alt = "Image failed to load"; img.style.display = 'none'; };
                          messageContentDiv.appendChild(img);
                          hasContent = true;
                     } else if (part && part.inlineData && part.inlineData.data && part.inlineData.mimeType) {
                          // Handle inlineData if present in history (e.g., from backend)
                          const img = document.createElement('img');
                          img.src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                          img.alt = "Chat image from history";
                          img.onerror = () => { img.alt = "Image failed to load"; img.style.display = 'none'; };
                          messageContentDiv.appendChild(img);
                          hasContent = true;
                     }
                     // Add speaker button logic if needed (can be added later after text is complete)
                 });
             } else if (isThinking) {
                 const p = document.createElement('p');
                 p.textContent = 'Thinking...'; // Use more descriptive text
                 p.style.opacity = '0.7'; // Make it visually distinct
                 messageContentDiv.appendChild(p);
                 hasContent = true;
             }

             // Only append if there's actual content or it's a thinking message
             if (hasContent) {
                messageDiv.innerHTML = `<div class="avatar"><i class="fa-solid ${avatarIcon}"></i></div>`;
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble';
                messageBubble.appendChild(messageContentDiv);
                messageDiv.appendChild(messageBubble);

                messageContainer.appendChild(messageDiv); // **appendChild call**

                // **Safety Check 2: Ensure chatMain exists before scrolling**
                if (chatMain) {
                    chatMain.scrollTo({ top: chatMain.scrollHeight, behavior: 'smooth' });
                } else {
                    console.error("Error: chatMain element not found for scrolling.");
                }
                return messageDiv; // Return the whole message div for potential modification (like removing 'thinking')
            }
            return null; // Return null if nothing was added
         };


        const startNewChat = () => {
            currentChatId = null;
             if (chatHeaderTitle) chatHeaderTitle.textContent = "FarmWise Bot"; // Reset title
            if (messageContainer) messageContainer.innerHTML = '';
            if (userInput) userInput.value = '';
            removeImage(); // Also disables send button if input is empty
            addMessage('bot', [{ type: 'text', text: 'Hello! Ask me anything about agriculture, or upload a plant image for diagnosis.' }]);
            document.querySelectorAll('#recent-chats-list li.active').forEach(li => li.classList.remove('active'));

            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                 body.classList.remove('sidebar-open'); // Change to remove
                 if (sidebarOverlay) sidebarOverlay.style.display = 'none';
            }
            if (userInput) userInput.focus();
        };

        const removeImage = () => {
            selectedFile = null;
            if (imageInput) imageInput.value = ''; // Clear file input value
            if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
            if (imagePreview && imagePreview.src) {
                URL.revokeObjectURL(imagePreview.src); // Clean up blob URL
                imagePreview.src = '';
            }
             // Update send button state
             if (sendBtn && userInput) {
                sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
             }
        };

        const fetchRecentChats = async () => {
            // **Safety Check:** Ensure list element exists
            if (!recentChatsList) {
                console.error("Cannot fetch chats: recentChatsList element not found.");
                return;
            }
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/chats`);
                 if (!response) return; // fetchWithAuth handles errors/redirects

                const chats = await response.json();
                recentChatsList.innerHTML = ''; // Clear list

                if (!Array.isArray(chats) || chats.length === 0) {
                     recentChatsList.innerHTML = '<li style="color: var(--text-secondary); padding-left: 15px; cursor: default;">No recent chats.</li>';
                     return;
                }

                chats.forEach(chat => {
                    const li = document.createElement('li');
                    li.dataset.chatId = chat._id; // Use dataset for easier access
                    if (chat._id === currentChatId) li.classList.add('active');
                    li.innerHTML = `
                        <span class="chat-title" title="${chat.title || 'Untitled Chat'}">${chat.title || 'Untitled Chat'}</span>
                        <button class="delete-chat-btn" data-chat-id="${chat._id}"><i class="fa-solid fa-trash-can"></i></button>
                    `;
                    // Add click listener directly to li for loading chat
                    li.addEventListener('click', (e) => {
                         // Only load if the click wasn't on the delete button itself
                         if (!e.target.closest('.delete-chat-btn')) {
                            loadChatHistory(chat._id);
                         }
                    });
                    recentChatsList.appendChild(li); // **appendChild call**
                });

                // Add delete listeners after all items are in the DOM
                 addDeleteButtonListeners();

            } catch (error) {
                 if (error.message !== 'Session expired') { // Avoid double alerts
                    console.error('Failed to load recent chats:', error);
                    if (recentChatsList) recentChatsList.innerHTML = '<li>Error loading chats.</li>';
                 }
            }
        };

        // --- FIXED loadChatHistory ---
        const loadChatHistory = async (chatId) => {
             if (currentChatId === chatId) return; // Prevent unnecessary reloads

             // **Safety Checks**
             if (!messageContainer || !chatHeaderTitle || !recentChatsList) {
                 console.error("Cannot load history: Required container elements not found.");
                 return;
             }

             currentChatId = chatId;
             messageContainer.innerHTML = ''; // Clear previous messages
             addMessage('bot', [{ type: 'text', text: 'Loading chat history...' }], true); // Show loading indicator
             removeImage(); // Clear any pending image/input

             // Update sidebar active state
             document.querySelectorAll('#recent-chats-list li').forEach(li => {
                 li.classList.toggle('active', li.dataset.chatId === chatId);
             });

             // Update header title (find title from sidebar list item)
             const activeLi = recentChatsList.querySelector(`li[data-chat-id="${chatId}"] .chat-title`);
             chatHeaderTitle.textContent = activeLi ? activeLi.textContent : "FarmWise Bot";

             // Close sidebar on mobile
             if (window.innerWidth <= 768) {
                 body.classList.remove('sidebar-open');
                 if (sidebarOverlay) sidebarOverlay.style.display = 'none';
             }

             try {
                 const response = await fetchWithAuth(`${API_BASE_URL}/api/chat/${chatId}`);
                 if (!response) return; // Exit if fetch failed

                 const chatData = await response.json(); // Expect full chat object { _id, title, history: [...] }
                 const history = chatData.history || []; // Get history array, default to empty

                 messageContainer.innerHTML = ''; // Clear loading message

                 if (history.length === 0) {
                    addMessage('bot', [{ type: 'text', text: 'This chat seems empty.' }]);
                 } else {
                     history.forEach(msg => {
                         const sender = msg.role === 'model' ? 'bot' : 'user';

                         // **CRITICAL FIX: Process the 'parts' array**
                         let contentToAdd = [];
                         if (Array.isArray(msg.parts)) {
                             msg.parts.forEach(part => {
                                 if (part.text) {
                                     contentToAdd.push({ type: 'text', text: part.text });
                                 } else if (part.inlineData && part.inlineData.data && part.inlineData.mimeType) {
                                     // Construct data URL for images stored in history
                                     contentToAdd.push({ type: 'image_url', image_url: { url: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}` } });
                                 }
                             });
                         }
                         // Only add if we found valid parts
                         if (contentToAdd.length > 0) {
                            addMessage(sender, contentToAdd);
                         }
                         // --- END FIX ---
                     });
                 }
                 // Scroll to bottom after loading all messages
                 if (chatMain) chatMain.scrollTop = chatMain.scrollHeight;

             } catch (error) {
                  if (error.message !== 'Session expired') {
                     console.error('Failed to load chat history:', error);
                     if (messageContainer) { // Check exists before modifying
                        messageContainer.innerHTML = ''; // Clear loading message
                        addMessage('bot', [{ type: 'text', text: `Error loading chat: ${error.message}` }]);
                     }
                  }
             }
        };


        const deleteChat = async (chatId) => {
            if (!confirm('Are you sure you want to delete this chat?')) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/chat/${chatId}`, { method: 'DELETE' });
                if (!response) return; // Exit if fetch failed

                 // Check server response status explicitly
                 if (response.status !== 200 && response.status !== 204) { // Allow OK or No Content
                     const errorData = await response.json().catch(() => ({}));
                     throw new Error(errorData.message || `Failed to delete chat (Status: ${response.status})`);
                 }


                if (currentChatId === chatId) {
                    startNewChat(); // Start new if active chat deleted
                }
                // Visually remove from list
                const listItem = recentChatsList?.querySelector(`li[data-chat-id="${chatId}"]`);
                if (listItem) listItem.remove();

                // Check if list is now empty
                if (recentChatsList && recentChatsList.children.length === 0) {
                     recentChatsList.innerHTML = '<li style="color: var(--text-secondary); padding-left: 15px; cursor: default;">No recent chats.</li>';
                }

            } catch (error) {
                 if (error.message !== 'Session expired') {
                    console.error('Delete chat error:', error);
                    alert(`Error deleting chat: ${error.message}`);
                 }
            }
        };

        // Helper to attach listeners to delete buttons
        const addDeleteButtonListeners = () => {
             if (!recentChatsList) return;
             recentChatsList.querySelectorAll('.delete-chat-btn').forEach(button => {
                 // Clone and replace to ensure only one listener is attached
                 const newButton = button.cloneNode(true);
                 button.parentNode.replaceChild(newButton, button);
                 newButton.addEventListener('click', (e) => {
                     e.stopPropagation(); // VERY important to prevent li click
                     deleteChat(newButton.dataset.chatId);
                 });
             });
        };


        // --- EVENT LISTENERS ---
        if (chatForm) chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!userInput || !sendBtn) return; // Safety check

            const userText = userInput.value.trim();
            if (!userText && !selectedFile) return;

            // Optimistic UI update
            const userMessageContent = [];
            if (selectedFile && imagePreview && imagePreview.src) userMessageContent.push({ type: 'image_url', image_url: { url: imagePreview.src } });
            if (userText) userMessageContent.push({ type: 'text', text: userText });
            addMessage('user', userMessageContent);

            const thinkingMessageDiv = addMessage('bot', null, true); // Add thinking message

            // Prepare form data
            const formData = new FormData();
            // Use a default message if only image exists
            formData.append('message', (selectedFile && !userText) ? "Analyze the attached image" : userText);
            if (selectedFile) formData.append('image', selectedFile, selectedFile.name); // Include filename
            if (currentChatId) formData.append('chatId', currentChatId);
            // Append language if needed by backend (check api.js)
            // formData.append('language', currentLanguage);

            // Store file reference before resetting UI
            const tempSelectedFile = selectedFile;

            // Reset UI
            userInput.value = '';
            removeImage(); // This handles disabling sendBtn too
            sendBtn.disabled = true; // Explicitly disable during request


            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/chat`, { method: 'POST', body: formData });
                if (!response) return; // Exit if fetch failed

                const data = await response.json(); // Assume response is always JSON

                // Remove thinking message before adding actual reply
                if (thinkingMessageDiv) thinkingMessageDiv.remove();

                if (data.reply && data.reply.trim() !== '') {
                    addMessage('bot', [{ type: 'text', text: data.reply }]);
                } else {
                    addMessage('bot', [{ type: 'text', text: "Sorry, I couldn't generate a response." }]);
                }

                const wasNewChat = !currentChatId;
                if (data.newChatId) {
                    currentChatId = data.newChatId;
                }
                if (wasNewChat && data.newChatId) { // Only refresh if it was genuinely new
                    await fetchRecentChats(); // Refresh sidebar
                     // Highlight the new chat
                     const newLi = recentChatsList?.querySelector(`li[data-chat-id="${currentChatId}"]`);
                     if (newLi) newLi.classList.add('active');
                     // Update header title if it's a new chat
                     if (chatHeaderTitle && newLi) {
                        chatHeaderTitle.textContent = newLi.querySelector('.chat-title')?.textContent || "FarmWise Bot";
                     }
                } else if (currentChatId) {
                     // Optionally refresh to update sorting by 'updatedAt'
                     // await fetchRecentChats();
                }

            } catch (error) {
                if (thinkingMessageDiv) thinkingMessageDiv.remove(); // Remove thinking on error too
                 if (error.message !== 'Session expired') {
                    console.error('Send message error:', error);
                    addMessage('bot', [{ type: 'text', text: `Sorry, an error occurred: ${error.message}` }]);
                 }
            } finally {
                // Re-enable button only if input/image allows
                 if(userInput && sendBtn) sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
                 if(userInput) userInput.focus();
            }
        });

        if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);

        // Sidebar List Click (delegated listener) - Moved inside fetchRecentChats

        // Image Button & Input
        if (imageBtn) imageBtn.addEventListener('click', () => imageInput?.click());
        if (imageInput) imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                 if (!file.type.startsWith('image/')) {
                     alert('Please select an image file.');
                     removeImage(); // Reset if invalid
                     return;
                 }
                selectedFile = file;
                 if (imagePreview.src) URL.revokeObjectURL(imagePreview.src);
                imagePreview.src = URL.createObjectURL(file);
                if (imagePreviewContainer) imagePreviewContainer.style.display = 'block';
                if (sendBtn) sendBtn.disabled = false; // Enable send when image is added
            } else {
                 removeImage(); // Reset if no file selected/cancelled
            }
        });
        if (removeImageBtn) removeImageBtn.addEventListener('click', removeImage);

        // Sidebar Toggle Button
        if (menuToggleBtn) menuToggleBtn.addEventListener('click', (e) => {
             e.stopPropagation();
             body.classList.toggle('sidebar-closed'); // Toggle the class on body
             // Toggle overlay visibility on mobile
             if (window.innerWidth <= 768) {
                 if (!body.classList.contains('sidebar-closed')) {
                     if (sidebarOverlay) sidebarOverlay.style.display = 'block';
                 } else {
                     if (sidebarOverlay) sidebarOverlay.style.display = 'none';
                 }
             }
        });

         // Sidebar Overlay Click
         if (sidebarOverlay) sidebarOverlay.addEventListener('click', () => {
             body.classList.add('sidebar-closed');
             sidebarOverlay.style.display = 'none';
         });


        // Theme Toggle Button
        if (themeToggleBtn) themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.documentElement.classList.contains('dark-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // Enable/Disable Send Button based on input
         if (userInput && sendBtn) {
            userInput.addEventListener('input', () => {
                sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
            });
         }


        // --- INITIALIZATION ---
        const initializeApp = async () => {
            // Apply theme first
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            // Set initial sidebar state based on screen size
             if (window.innerWidth <= 768) {
                 body.classList.add('sidebar-closed');
             } else {
                 body.classList.remove('sidebar-closed');
             }


            // Auth check already done at top level script

            // Fetch initial data if logged in
            if (localStorage.getItem('token')) {
                await fetchRecentChats();
                startNewChat(); // Always start with a new chat view
            }
             // Ensure send button initial state is correct
             if(userInput && sendBtn) sendBtn.disabled = userInput.value.trim() === '' && !selectedFile;
        };

        initializeApp(); // Run initialization
    });
    </script>
</body>
</html>
