<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmWise - AI-Powered Farming Advisory</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
    /* --- Your full CSS as previously provided, unchanged --- */
    </style>
</head>
<body>
    <script>
        // AUTH GUARD: Checks for presence of token
        const token = localStorage.getItem('token');
        if (!token) {
            // Token missing, force login
            window.location.href = 'login.html';
        }
    </script>

    <header class="navbar">
        <div class="navbar-container">
            <a href="#" class="logo" data-lang-key="logo_text">FarmWise</a>
            <nav class="nav-menu">
                <a href="chatbot.html" data-lang-key="nav_chatbot"><i class="fa-solid fa-robot"></i> Krishi Sahayi Bot</a>
                <a href="plant.html" data-lang-key="nav_crop_disease"><i class="fa-solid fa-leaf"></i> Crop Disease Diagnosis</a>
                <a href="weather.html" data-lang-key="nav_weather"><i class="fa-solid fa-cloud-sun"></i> Weather Prediction</a>
                <a href="community.html" data-lang-key="nav_community"><i class="fa-solid fa-users"></i> Farmer Community</a>
            </nav>
            <div class="nav-actions">
                <div class="language-dropdown">
                    <button class="language-selector">English <i class="fa-solid fa-angle-down"></i></button>
                    <ul class="dropdown-content">
                        <li><a href="#" data-lang="en">English</a></li>
                        <li><a href="#" data-lang="ta">தமிழ் (Tamil)</a></li>
                        <li><a href="#" data-lang="ml">മലയാളം (Malayalam)</a></li>
                    </ul>
                </div>
                <button id="theme-toggle" class="theme-button" title="Toggle Theme"><i class="fa-solid fa-sun"></i></button>
                <button id="profile-btn" title="View Profile"><i class="fa-solid fa-user-circle"></i></button>
                <button class="hamburger-menu" id="hamburger-btn"><i class="fa-solid fa-bars"></i></button>
            </div>
        </div>
        <div class="mobile-nav-dropdown" id="mobile-nav-dropdown">
            <nav class="nav-menu">
                <a href="chatbot.html" data-lang-key="nav_chatbot"><i class="fa-solid fa-robot"></i> Krishi Sahayi Bot</a>
                <a href="plant.html" data-lang-key="nav_crop_disease"><i class="fa-solid fa-leaf"></i> Crop Disease Diagnosis</a>
                <a href="weather.html" data-lang-key="nav_weather"><i class="fa-solid fa-cloud-sun"></i> Weather Prediction</a>
                <a href="community.html" data-lang-key="nav_community"><i class="fa-solid fa-users"></i> Farmer Community</a>
            </nav>
        </div>
    </header>

    <main>
        <section id="home" class="hero">
            <div class="hero-overlay">
                <div class="hero-content container">
                    <h1 class="hero-title" data-lang-key="hero_title">AI-Powered Guidance for Every Farmer</h1>
                    <p class="hero-description" data-lang-key="hero_description">
                        Get real-time weather updates, chat with our AI assistant, and manage your profile.
                    </p>
                </div>
            </div>
        </section>
    </main>

    <div id="profile-overlay" class="profile-overlay"></div>
    <div id="side-profile-panel" class="side-profile-panel">
        <div class="profile-header">
            <h3 data-lang-key="profile_title">My Profile</h3>
            <button id="close-panel-btn" class="close-button">&times;</button>
        </div>
        <div class="profile-details">
            <ul>
                <li><span class="label" data-lang-key="profile_label_username">Username</span><span id="profile-username" class="value"></span></li>
                <li><span class="label" data-lang-key="profile_label_email">Email Address</span><span id="profile-email" class="value"></span></li>
                <li><span class="label" data-lang-key="profile_label_phone">Phone Number</span><span id="profile-phone" class="value"></span></li>
                <li><span class="label" data-lang-key="profile_label_state">State</span><span id="profile-state" class="value"></span></li>
            </ul>
        </div>
        <button id="logout-btn" class="logout-button"><i class="fa-solid fa-right-from-bracket"></i> <span data-lang-key="logout_button">Logout</span></button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const body = document.body;
        const themeToggleBtn = document.getElementById('theme-toggle');
        const profileBtn = document.getElementById('profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const languageDropdown = document.querySelector('.language-dropdown');
        const languageSelectorBtn = document.querySelector('.language-selector');
        const dropdownContent = document.querySelector('.dropdown-content');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const mobileNavDropdown = document.getElementById('mobile-nav-dropdown');
        const profileOverlay = document.getElementById('profile-overlay');
        const sideProfilePanel = document.getElementById('side-profile-panel');
        const closePanelBtn = document.getElementById('close-panel-btn');

        // --- AUTHENTICATION & DATA LOADING ---
        const token = localStorage.getItem('token');
        console.log('Loaded token:', token); // <-- DEBUG: Check token presence

        fetchProfileData(token);
        
        async function fetchProfileData(token) {
            try {
                const response = await fetch('https://main-back-g4pq.onrender.com/api/profile', {
                    headers: { 'x-auth-token': token }
                });
                // Only log out for 401/403 token problems; otherwise, show error.
                if (response.status === 401 || response.status === 403) {
                    alert('Session expired or unauthorized. Please sign in again.');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                if (!response.ok) {
                    // Debug message for other errors (network, backend bug, CORS, etc.)
                    const errMsg = await response.text();
                    alert('Failed to load profile: ' + errMsg);
                    return;
                }
                const userData = await response.json();
                document.getElementById('profile-username').textContent = userData.username;
                document.getElementById('profile-email').textContent = userData.email;
                document.getElementById('profile-phone').textContent = userData.phone;
                document.getElementById('profile-state').textContent = userData.state;
            } catch (error) {
                // Network or unexpected JavaScript error
                alert('Error loading profile: ' + error.message);
            }
        }

        // --- LANGUAGE FUNCTIONALITY ---
        const languageData = {
            en: {
                logo_text: "FarmWise", nav_chatbot: "Krishi Sahayi Bot", nav_crop_disease: "Crop Disease Diagnosis", nav_weather: "Weather Prediction", nav_community: "Farmer Community",
                hero_title: "AI-Powered Guidance for Every Farmer", hero_description: "Get real-time weather updates, chat with our AI assistant, and manage your profile.",
                profile_title: "My Profile", profile_label_username: "Username",
                profile_label_email: "Email Address", profile_label_phone: "Phone Number", profile_label_state: "State",
                logout_button: "Logout"
            },
            ta: {
                logo_text: "பார்ம்வைஸ்", nav_chatbot:" கிருஷி சஹாயி பாட்", nav_crop_disease: "பயிர் நோய் கண்டறிதல்", nav_weather: "வானிலை முன்னறிவிப்பு", nav_community: "விவசாயிகள் சமூகம்",
                hero_title: "ஒவ்வொரு விவசாயிக்கும் AI-இயங்கும் வழிகாட்டுதல்", hero_description: "நிகழ்நேர வானிலை அறிவிப்புகளைப் பெறுங்கள், எங்கள் AI உதவியாளருடன் அரட்டையடிக்கவும், உங்கள் சுயவிவரத்தை நிர்வகிக்கவும்.",
                profile_title: "என் சுயவிவரம்", profile_label_username: "பயனர்பெயர்",
                profile_label_email: "மின்னஞ்சல் முகவரி", profile_label_phone: "தொலைபேசி எண்", profile_label_state: "மாநிலம்",
                logout_button: "வெளியேறு"
            },
            ml: {
                logo_text: "ഫാംവൈസ്", nav_chatbot: "കൃഷി സഹായി ബോട്ട്", nav_crop_disease: "വിള രോഗനിർണയം", nav_weather: "കാലാവസ്ഥാ പ്രവചനം", nav_community: "കർഷക സമൂഹം",
                hero_title: "ഓരോ കർഷകനും AI പിന്തുണയുള്ള മാർഗ്ഗനിർദ്ദേശം", hero_description: "തത്സമയ കാലാവസ്ഥാ അപ്‌ഡേറ്റുകൾ നേടുക, ഞങ്ങളുടെ AI അസിസ്റ്റന്റുമായി ചാറ്റ് ചെയ്യുക, നിങ്ങളുടെ പ്രൊഫൈൽ നിയന്ത്രിക്കുക.",
                profile_title: "എന്റെ പ്രൊഫൈൽ", profile_label_username: "ഉപയോക്തൃനാമം",
                profile_label_email: "ഇമെയിൽ വിലാസം", profile_label_phone: "ഫോൺ നമ്പർ", profile_label_state: "സംസ്ഥാനം",
                logout_button: "ലോഗൗട്ട്"
            }
        };

        const setLanguage = (lang) => {
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (languageData[lang]?.[key]) {
                    const iconHTML = element.querySelector('i')?.outerHTML || '';
                    element.innerHTML = iconHTML + ' ' + languageData[lang][key];
                }
            });
            const selectedLangText = document.querySelector(`.dropdown-content a[data-lang="${lang}"]`).textContent;
            languageSelectorBtn.innerHTML = `${selectedLangText} <i class="fa-solid fa-angle-down"></i>`;
            localStorage.setItem('language', lang);
        };

        dropdownContent.addEventListener('click', (event) => {
            if (event.target.tagName === 'A') {
                event.preventDefault();
                const lang = event.target.getAttribute('data-lang');
                setLanguage(lang);
                dropdownContent.classList.remove('show');
            }
        });

        languageSelectorBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });

        const savedLang = localStorage.getItem('language') || 'en';
        setLanguage(savedLang);

        // --- THEME TOGGLE FUNCTIONALITY ---
        const themeIcon = themeToggleBtn.querySelector('i');
        const applyTheme = (theme) => {
            if (theme === 'light') {
                body.classList.add('light-mode');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
            } else {
                body.classList.remove('light-mode');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
            }
        };

        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);

        themeToggleBtn.addEventListener('click', () => {
            const newTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- PROFILE PANEL & LOGOUT ---
        const toggleProfilePanel = () => {
            profileOverlay.classList.toggle('show');
            sideProfilePanel.classList.toggle('show');
        };

        profileBtn.addEventListener('click', toggleProfilePanel);
        closePanelBtn.addEventListener('click', toggleProfilePanel);
        profileOverlay.addEventListener('click', toggleProfilePanel);

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('language'); // clears language preference on logout
            localStorage.removeItem('theme'); // clears theme preference on logout
            window.location.href = 'login.html';
        });

        // --- MOBILE NAV ---
        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            mobileNavDropdown.classList.toggle('show');
        });

        // Close dropdowns if clicked outside
        window.addEventListener('click', (e) => {
            if (!languageDropdown.contains(e.target)) {
                dropdownContent.classList.remove('show');
            }
            if (mobileNavDropdown.classList.contains('show') && !hamburgerBtn.contains(e.target) && !mobileNavDropdown.contains(e.target)) {
                mobileNavDropdown.classList.remove('show');
            }
        });
    });
    </script>
</body>
</html>
